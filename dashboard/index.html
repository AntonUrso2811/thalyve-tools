<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Anton Empire â€” Command Centre</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--card:#12121a;--border:#1e1e2e;--text:#e4e4e7;--muted:#71717a;--accent:#8b5cf6;--accent2:#a78bfa;--green:#22c55e;--red:#ef4444;--amber:#f59e0b;--blue:#3b82f6;--teal:#14b8a6}
body{font-family:-apple-system,'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.ctr{max-width:1300px;margin:0 auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:8px}
h1{font-size:20px;font-weight:700}h1 span{color:var(--accent)}
.badge{font-size:10px;padding:3px 9px;border-radius:16px;font-weight:600;background:var(--accent);color:#fff}
.tabs{display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap}
.tab{padding:7px 15px;border-radius:7px;font-size:12px;cursor:pointer;border:1px solid var(--border);color:var(--muted);background:transparent;font-weight:500;transition:.2s}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.tab:hover:not(.active){border-color:var(--accent);color:var(--text)}
.page{display:none}.page.active{display:block}
.grid{display:grid;gap:12px;margin-bottom:16px}
.g6{grid-template-columns:repeat(auto-fit,minmax(170px,1fr))}
.g2{grid-template-columns:1fr 1fr}
@media(max-width:768px){.g2{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:15px}
.card h2{font-size:13px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.sl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
.sv{font-size:22px;font-weight:700}
.ss{font-size:10px;margin-top:2px}
.green{color:var(--green)}.red{color:var(--red)}.amber{color:var(--amber)}.blue{color:var(--blue)}.purple{color:var(--accent2)}.teal{color:var(--teal)}
.hl{border-radius:10px;padding:16px;margin-bottom:16px}
.hl-p{background:linear-gradient(135deg,rgba(139,92,246,.1),rgba(59,130,246,.07));border:1px solid rgba(139,92,246,.25)}
.hl-g{background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(20,184,166,.06));border:1px solid rgba(34,197,94,.2)}
.hl-r{background:linear-gradient(135deg,rgba(239,68,68,.08),rgba(245,158,11,.06));border:1px solid rgba(239,68,68,.2)}
.pl{display:grid;grid-template-columns:1fr auto;gap:3px 18px;max-width:450px;font-size:12px}
.pl-sep{border-top:1px solid var(--border);padding-top:4px;font-weight:600}
.pl-total{border-top:2px solid var(--accent);padding-top:5px;font-weight:700;font-size:14px}
.fg{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px}
.fg-item{display:flex;flex-direction:column;gap:3px}
.fg-item label{font-size:10px;color:var(--muted);text-transform:uppercase}
.fg-item input,.fg-item select{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:7px;font-size:12px;outline:none}
.fg-item input:focus{border-color:var(--accent)}
.fw{grid-column:1/-1}
button{background:var(--accent);color:#fff;border:none;padding:9px 18px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;transition:.2s}
button:hover{background:var(--accent2)}
.btn-s{padding:4px 10px;font-size:10px}
.btn-o{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-o:hover{border-color:var(--accent);color:var(--text);background:transparent}
.btn-r{background:var(--red)}.btn-r:hover{background:#dc2626}
table{width:100%;border-collapse:collapse;font-size:11px}
th{text-align:left;padding:7px 5px;color:var(--muted);font-size:10px;text-transform:uppercase;border-bottom:1px solid var(--border)}
td{padding:7px 5px;border-bottom:1px solid var(--border)}
tr:hover td{background:rgba(139,92,246,.03)}
.empty{text-align:center;padding:25px;color:var(--muted);font-size:11px}
.chart-row{display:flex;align-items:center;gap:7px;margin-bottom:5px}
.chart-lbl{font-size:10px;color:var(--muted);width:50px;text-align:right;flex-shrink:0}
.chart-bg{flex:1;height:22px;background:var(--bg);border-radius:5px;overflow:hidden}
.chart-bar{height:100%;border-radius:5px;display:flex;align-items:center;padding-left:6px;font-size:10px;font-weight:600;color:#fff;transition:width .4s}
.toast{position:fixed;bottom:16px;right:16px;background:var(--green);color:#fff;padding:9px 16px;border-radius:7px;font-size:11px;font-weight:600;transform:translateY(80px);opacity:0;transition:.3s;z-index:100}
.toast.show{transform:translateY(0);opacity:1}
.wm{text-align:center;color:#333;font-size:9px;margin-top:25px;padding:12px}
.brand-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--accent)}
.brand-header h2{font-size:16px;margin:0}
.brand-badge{font-size:10px;background:var(--green);color:#fff;padding:2px 8px;border-radius:10px}
</style>
</head>
<body>
<div class="ctr">
  <header>
    <div><h1>ğŸ”± <span>Anton Empire</span> â€” Command Centre</h1><p style="font-size:10px;color:var(--muted);margin-top:2px">Company P&L â€¢ Brand Performance â€¢ Expenses â€¢ Tax Provisioning</p></div>
    <div style="display:flex;gap:5px;align-items:center">
      <button class="btn-s btn-o" onclick="exportAll()">ğŸ“¥ Export</button>
      <button class="btn-s btn-o" onclick="exportJSON()">ğŸ’¾ Backup</button>
      <span class="badge" id="lastSync">â€”</span>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="nav('overview',this)">ğŸ“Š Company Overview</div>
    <div class="tab" onclick="nav('brand',this)">ğŸ· THALYVEâ„¢</div>
    <div class="tab" onclick="nav('expenses',this)">ğŸ’° Company Expenses</div>
    <div class="tab" onclick="nav('log',this)">ğŸ“… Daily Log</div>
    <div class="tab" onclick="nav('tasks',this)">ğŸ¯ 5 Critical Tasks</div>
    <div class="tab" onclick="nav('team',this)">ğŸ‘¥ Team</div>
    <div class="tab" onclick="nav('kpi',this)">ğŸ¯ KPI Targets</div>
    <div class="tab" onclick="nav('roadmap',this)">ğŸ—º Roadmap</div>
    <div class="tab" onclick="nav('tasklog',this)">âš¡ Task Log</div>
    <div class="tab" onclick="nav('settings',this)">âš™ï¸ Settings</div>
    <div class="tab" onclick="nav('backup',this)" style="border-color:var(--red);color:var(--red)">ğŸ†˜ Backup & Recovery</div>
  </div>

  <!-- ===== COMPANY OVERVIEW ===== -->
  <div class="page active" id="p-overview">
    <div class="grid g6">
      <div class="card"><div class="sl">Total Revenue (All Brands)</div><div class="sv green" id="o-rev">$0</div><div class="ss" id="o-orders">0 orders</div></div>
      <div class="card"><div class="sl">Total Ad Spend</div><div class="sv red" id="o-ads">$0</div><div class="ss" id="o-adpct">â€”</div></div>
      <div class="card"><div class="sl">Total COGS</div><div class="sv amber" id="o-cogs">$0</div><div class="ss" id="o-cogspct">â€”</div></div>
      <div class="card"><div class="sl">Company Expenses</div><div class="sv blue" id="o-opex">$0</div><div class="ss" id="o-opexn">â€”</div></div>
      <div class="card"><div class="sl">Tax Provision (est.)</div><div class="sv teal" id="o-tax">$0</div><div class="ss" id="o-taxr">â€”</div></div>
      <div class="card"><div class="sl">Net Company Profit</div><div class="sv" id="o-net">$0</div><div class="ss" id="o-netm">â€”</div></div>
    </div>

    <!-- P&L Waterfall -->
    <div class="hl hl-p">
      <h3 style="font-size:13px;margin-bottom:10px">ğŸ“‹ Company P&L</h3>
      <div class="pl" id="o-pl">
        <span>Gross Revenue (all brands)</span><span class="green" id="pl-rev">$0</span>
        <span>âˆ’ Total COGS</span><span class="red" id="pl-cogs">$0</span>
        <span class="pl-sep">Gross Profit</span><span class="pl-sep green" id="pl-gross">$0</span>
        <span>âˆ’ Total Ad Spend</span><span class="red" id="pl-ads">$0</span>
        <span>âˆ’ Company Expenses</span><span class="red" id="pl-opex">$0</span>
        <span class="pl-sep">Pre-Tax Profit</span><span class="pl-sep" id="pl-pretax">$0</span>
        <span>âˆ’ Tax Provision (est.)</span><span class="red" id="pl-tax">$0</span>
        <span class="pl-total">Net Profit (After Tax Est.)</span><span class="pl-total" id="pl-net">$0</span>
      </div>
    </div>

    <!-- Brand Summary -->
    <div class="card">
      <h2>ğŸ· Brand Performance</h2>
      <table>
        <thead><tr><th>Brand</th><th>Revenue</th><th>Orders</th><th>Ad Spend</th><th>COGS</th><th>Brand Profit</th><th>ROAS</th><th>Margin</th></tr></thead>
        <tbody id="o-brands"><tr><td colspan="8" class="empty">No brand data yet</td></tr></tbody>
      </table>
    </div>

    <!-- 7-day chart -->
    <div class="card" style="margin-top:12px">
      <h2>ğŸ“ˆ Last 7 Days</h2>
      <div id="o-chart"><div class="empty">Add daily entries to see trends</div></div>
    </div>
  </div>

  <!-- ===== BRAND PAGE ===== -->
  <div class="page" id="p-brand">
    <!-- Brand Header -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
      <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#a855f7);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">ğŸ·</div>
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:8px"><h2 style="margin:0;font-size:20px">THALYVEâ„¢</h2><span class="brand-badge">ACTIVE</span></div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px">Health & Wellness Â· Anti-Shortcut Â· Foundations First</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:var(--muted)">Ad Launch</div>
        <div style="font-size:13px;font-weight:700;color:var(--amber)" id="b-launch-status">Feb 28</div>
      </div>
    </div>

    <!-- Hero KPIs â€” 3 big cards -->
    <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px">
      <div class="card" style="text-align:center;border-top:3px solid var(--green);padding:16px">
        <div class="sl" style="margin-bottom:6px">Revenue</div>
        <div style="font-size:28px;font-weight:800;color:var(--green)" id="b-rev">$0.00</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px" id="b-orders">0 orders</div>
      </div>
      <div class="card" style="text-align:center;border-top:3px solid var(--red);padding:16px">
        <div class="sl" style="margin-bottom:6px">Ad Spend</div>
        <div style="font-size:28px;font-weight:800;color:var(--red)" id="b-ads">$0.00</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px" id="b-daily">$100/day budget</div>
      </div>
      <div class="card" style="text-align:center;border-top:3px solid var(--blue);padding:16px">
        <div class="sl" style="margin-bottom:6px">Net Profit</div>
        <div style="font-size:28px;font-weight:800" id="b-profit">$0.00</div>
        <div style="font-size:11px;margin-top:4px" id="b-margin">â€”</div>
      </div>
    </div>

    <!-- Secondary KPIs â€” compact row -->
    <div class="grid" style="grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px">
      <div class="card" style="text-align:center;padding:10px">
        <div style="font-size:10px;text-transform:uppercase;color:var(--muted);letter-spacing:0.5px">COGS</div>
        <div style="font-size:18px;font-weight:700;color:var(--amber);margin-top:2px" id="b-cogs">$0</div>
      </div>
      <div class="card" style="text-align:center;padding:10px">
        <div style="font-size:10px;text-transform:uppercase;color:var(--muted);letter-spacing:0.5px">ROAS</div>
        <div style="font-size:18px;font-weight:700;color:var(--purple);margin-top:2px" id="b-roas">0.00x</div>
        <div style="font-size:9px;margin-top:1px" id="b-roast">â€”</div>
      </div>
      <div class="card" style="text-align:center;padding:10px">
        <div style="font-size:10px;text-transform:uppercase;color:var(--muted);letter-spacing:0.5px">CPA</div>
        <div style="font-size:18px;font-weight:700;color:var(--amber);margin-top:2px" id="b-cpa">$0</div>
        <div style="font-size:9px;margin-top:1px" id="b-cpat">â€”</div>
      </div>
      <div class="card" style="text-align:center;padding:10px">
        <div style="font-size:10px;text-transform:uppercase;color:var(--muted);letter-spacing:0.5px">Balance</div>
        <div style="font-size:18px;font-weight:700;color:var(--green);margin-top:2px" id="b-adleft">$1,000</div>
      </div>
    </div>

    <!-- Two-column: Products + Media Buying -->
    <div class="grid" style="grid-template-columns:1fr 300px;gap:12px;margin-bottom:12px">
      <!-- Product Breakdown -->
      <div class="card">
        <h2 style="font-size:13px;margin-bottom:10px">ğŸ“¦ Products</h2>
        <div id="b-prods-cards"></div>
        <table style="display:none"><tbody id="b-prods"></tbody></table>
      </div>

      <!-- Media Buying Sidebar -->
      <div class="card" style="background:linear-gradient(135deg,rgba(59,130,246,0.06),rgba(124,58,237,0.06))">
        <h2 style="font-size:13px;margin-bottom:12px">ğŸ“¡ Media Buying</h2>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg);border-radius:8px">
            <span style="font-size:11px;color:var(--muted)">Platform</span>
            <span style="font-size:13px;font-weight:700;color:var(--blue)">Meta Ads</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg);border-radius:8px">
            <span style="font-size:11px;color:var(--muted)">Agency</span>
            <span style="font-size:13px;font-weight:700">Ad Rail <span style="font-size:9px;color:var(--muted)">(3%)</span></span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg);border-radius:8px">
            <span style="font-size:11px;color:var(--muted)">Test Budget</span>
            <span style="font-size:13px;font-weight:700;color:var(--amber)">$100/day</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg);border-radius:8px">
            <span style="font-size:11px;color:var(--muted)">Structure</span>
            <span style="font-size:11px;font-weight:600">3 BMs Â· 1 Pixel</span>
          </div>
          <div style="margin-top:4px;padding:8px;border-radius:8px;background:rgba(76,175,80,0.08);border:1px solid rgba(76,175,80,0.2);text-align:center">
            <div style="font-size:9px;text-transform:uppercase;color:var(--muted);letter-spacing:0.5px">Warmup Status</div>
            <div style="font-size:12px;font-weight:700;color:var(--amber);margin-top:2px" id="b-warmup">In Progress Â· $5/day</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Daily Performance Chart -->
    <div class="card">
      <h2 style="font-size:13px;margin-bottom:8px">ğŸ“ˆ Daily Performance</h2>
      <div id="b-chart"><div class="empty" style="padding:24px;font-size:12px;color:var(--muted)">ğŸ“Š Data will populate once ads go live (Feb 28)</div></div>
    </div>
  </div>

  <!-- ===== EXPENSES ===== -->
  <div class="page" id="p-expenses">
    <div class="grid g2">
      <div class="card">
        <h2>â• Add Company Expense</h2>
        <div class="fg">
          <div class="fg-item"><label>Description</label><input id="e-name" placeholder="e.g. Shopify"></div>
          <div class="fg-item"><label>Category</label>
            <select id="e-cat"><option>Subscriptions</option><option>AI/API Costs</option><option>Domain/Hosting</option><option>Media Buying</option><option>Design/Creative</option><option>Legal/Compliance</option><option>Samples/Testing</option><option>Software/Tools</option><option>Tax</option><option>Other</option></select>
          </div>
          <div class="fg-item"><label>Amount ($)</label><input type="number" id="e-amt" step="0.01"></div>
          <div class="fg-item"><label>Frequency</label><select id="e-freq"><option value="monthly">Monthly</option><option value="annual">Annual</option><option value="one-time">One-time</option></select></div>
          <div class="fg-item"><label>Date</label><input type="date" id="e-date"></div>
          <div class="fg-item"><label>Notes</label><input id="e-notes"></div>
          <div class="fg-item fw"><button onclick="addExpense()">Add Expense</button></div>
        </div>
      </div>
      <div class="card">
        <h2>ğŸ”¥ Monthly Burn Rate</h2>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;margin-bottom:15px">
          <div><div style="font-size:20px;font-weight:700" class="red" id="e-recur">$0</div><div class="sl">Monthly Recurring</div></div>
          <div><div style="font-size:20px;font-weight:700" class="amber" id="e-once">$0</div><div class="sl">One-time</div></div>
          <div><div style="font-size:20px;font-weight:700" class="blue" id="e-burn">$0</div><div class="sl">Total / Month</div></div>
        </div>
        <table>
          <thead><tr><th>Description</th><th>Category</th><th>Amount</th><th>Freq</th><th></th></tr></thead>
          <tbody id="e-table"><tr><td colspan="5" class="empty">No expenses</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== DAILY LOG ===== -->
  <div class="page" id="p-log">
    <!-- Header -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
      <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">ğŸ“Š</div>
      <div style="flex:1">
        <h2 style="margin:0;font-size:18px">Daily P&L Log</h2>
        <div style="font-size:11px;color:var(--muted);margin-top:2px">Revenue Â· Ad Spend Â· Orders Â· Profit â€” tracked daily per product</div>
      </div>
      <div style="padding:6px 12px;border-radius:8px;background:rgba(76,175,80,0.08);border:1px solid rgba(76,175,80,0.2)">
        <div style="font-size:9px;text-transform:uppercase;color:var(--muted)">Automation</div>
        <div style="font-size:11px;font-weight:700;color:var(--amber)">Manual â†’ Auto when ads live</div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid" style="grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px">
      <div class="card" style="text-align:center;padding:12px;border-top:3px solid var(--green)">
        <div style="font-size:9px;text-transform:uppercase;color:var(--muted);letter-spacing:0.5px">Total Revenue</div>
        <div style="font-size:20px;font-weight:800;color:var(--green);margin-top:4px" id="dl-rev">$0</div>
      </div>
      <div class="card" style="text-align:center;padding:12px;border-top:3px solid var(--red)">
        <div style="font-size:9px;text-transform:uppercase;color:var(--muted);letter-spacing:0.5px">Total Ad Spend</div>
        <div style="font-size:20px;font-weight:800;color:var(--red);margin-top:4px" id="dl-ads">$0</div>
      </div>
      <div class="card" style="text-align:center;padding:12px;border-top:3px solid var(--blue)">
        <div style="font-size:9px;text-transform:uppercase;color:var(--muted);letter-spacing:0.5px">Net Profit</div>
        <div style="font-size:20px;font-weight:800;margin-top:4px" id="dl-profit">$0</div>
      </div>
      <div class="card" style="text-align:center;padding:12px;border-top:3px solid var(--purple)">
        <div style="font-size:9px;text-transform:uppercase;color:var(--muted);letter-spacing:0.5px">Avg ROAS</div>
        <div style="font-size:20px;font-weight:800;color:var(--purple);margin-top:4px" id="dl-roas">0.00x</div>
      </div>
      <div class="card" style="text-align:center;padding:12px;border-top:3px solid var(--amber)">
        <div style="font-size:9px;text-transform:uppercase;color:var(--muted);letter-spacing:0.5px">Total Orders</div>
        <div style="font-size:20px;font-weight:800;color:var(--amber);margin-top:4px" id="dl-orders">0</div>
      </div>
    </div>

    <!-- Metric Key -->
    <div style="padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px;margin-bottom:16px;display:flex;flex-wrap:wrap;gap:16px;font-size:10px;color:var(--muted)">
      <span>ğŸ“¦ <strong style="color:var(--text)">Orders</strong> = units sold</span>
      <span>ğŸ’° <strong style="color:var(--green)">Revenue</strong> = orders Ã— price</span>
      <span>ğŸ“¢ <strong style="color:var(--red)">Ad Spend</strong> = Meta ads cost</span>
      <span>ğŸ­ <strong style="color:var(--amber)">COGS</strong> = supplier cost per unit Ã— orders</span>
      <span>ğŸ“Š <strong style="color:var(--blue)">Profit</strong> = revenue âˆ’ ad spend âˆ’ COGS</span>
      <span>ğŸ¯ <strong style="color:var(--purple)">ROAS</strong> = revenue Ã· ad spend (2x+ = strong)</span>
    </div>

    <!-- Mini Chart -->
    <div class="card" style="margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h2 style="font-size:13px;margin:0">ğŸ“ˆ 7-Day Trend</h2>
        <span style="font-size:10px;color:var(--muted)" id="dl-period">â€”</span>
      </div>
      <div id="dl-chart"><div class="empty" style="padding:20px;font-size:12px;color:var(--muted)">Chart populates with first entry</div></div>
    </div>

    <!-- Two column: Log form + Entries -->
    <div class="grid" style="grid-template-columns:320px 1fr;gap:12px">
      <!-- Log Form -->
      <div class="card" style="background:linear-gradient(135deg,rgba(59,130,246,0.04),rgba(124,58,237,0.04))">
        <h2 style="font-size:13px;margin-bottom:12px">â• Log Entry</h2>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div><label style="font-size:10px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:3px">Date</label><input type="date" id="d-date" style="width:100%"></div>
          <div><label style="font-size:10px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:3px">Brand</label><select id="d-brand" style="width:100%"></select></div>
          <div><label style="font-size:10px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:3px">Product</label><select id="d-prod" style="width:100%"></select></div>
          <div class="grid g2">
            <div><label style="font-size:10px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:3px">Orders</label><input type="number" id="d-orders" value="0" min="0" style="width:100%"></div>
            <div><label style="font-size:10px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:3px">Ad Spend ($)</label><input type="number" id="d-ads" step="0.01" value="0" style="width:100%"></div>
          </div>
          <div><label style="font-size:10px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:3px">Revenue ($)</label><input type="number" id="d-rev" step="0.01" placeholder="Auto-calculated from orders" style="width:100%"></div>
          <button onclick="addDaily()" style="margin-top:4px;width:100%;padding:10px;font-weight:700">+ Add Entry</button>
        </div>
        <div style="margin-top:12px;padding:8px;background:var(--bg);border-radius:8px;font-size:10px;color:var(--muted)">
          ğŸ’¡ <strong>Coming soon:</strong> Forge will auto-log daily numbers from ad platform data. Zero manual input needed.
        </div>
      </div>

      <!-- Entries Table -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <h2 style="font-size:13px;margin:0">ğŸ“… All Entries</h2>
          <span style="font-size:10px;color:var(--muted)" id="dl-count">0 entries</span>
        </div>
        <table>
          <thead><tr><th title="Date the data was recorded">Date</th><th title="Which brand this entry belongs to">Brand</th><th title="Specific product sold">Product</th><th title="Number of units sold that day">Orders</th><th title="Total money received from sales (orders Ã— price)">Revenue</th><th title="Money spent on Meta ads that day">Ad Spend</th><th title="Cost of goods sold â€” what you paid the supplier per unit Ã— orders">COGS</th><th title="Revenue minus Ad Spend minus COGS = your actual take-home">Profit</th><th title="Return on Ad Spend â€” Revenue Ã· Ad Spend. Above 2x = strong, 1x = break-even">ROAS</th><th></th></tr></thead>
          <tbody id="d-table"><tr><td colspan="10" class="empty">No entries yet â€” log your first day or wait for automation ğŸš€</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== 5 CRITICAL TASKS ===== -->
  <div class="page" id="p-tasks">
    <!-- Header -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
      <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#ef4444,#f97316);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">ğŸ¯</div>
      <div style="flex:1">
        <h2 style="margin:0;font-size:18px">Critical Tasks</h2>
        <div style="font-size:11px;color:var(--muted);margin-top:2px">5 daily tasks per member that move the needle. Auto-generated 6AM.</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:10px;color:var(--muted)">Today</div>
        <div style="font-size:14px;font-weight:700;color:var(--accent)" id="ct-date">â€”</div>
      </div>
    </div>

    <!-- Overall Progress Ring + Stats -->
    <div class="grid" style="grid-template-columns:200px 1fr 1fr;gap:12px;margin-bottom:16px">
      <!-- Progress Ring -->
      <div class="card" style="text-align:center;padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center">
        <div style="position:relative;width:100px;height:100px">
          <svg width="100" height="100" style="transform:rotate(-90deg)">
            <circle cx="50" cy="50" r="42" fill="none" stroke="var(--bg)" stroke-width="8"/>
            <circle id="ct-ring" cx="50" cy="50" r="42" fill="none" stroke="var(--green)" stroke-width="8" stroke-dasharray="264" stroke-dashoffset="264" stroke-linecap="round" style="transition:stroke-dashoffset .6s"/>
          </svg>
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;font-weight:800" id="ct-overall">0%</div>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:8px">Overall Today</div>
      </div>

      <!-- ROI Tracker -->
      <div class="card" style="background:linear-gradient(135deg,rgba(76,175,80,0.05),rgba(59,130,246,0.05))">
        <h2 style="font-size:12px;margin-bottom:10px">ğŸ’° ROI Tracker <span style="font-size:9px;color:var(--muted);font-weight:400" id="roi-since">since â€”</span></h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div style="padding:8px;background:var(--bg);border-radius:8px;text-align:center">
            <div style="font-size:18px;font-weight:800;color:var(--green)" id="roi-equiv">$0</div>
            <div style="font-size:8px;text-transform:uppercase;color:var(--muted);margin-top:2px">Human Equiv. Cost Saved</div>
          </div>
          <div style="padding:8px;background:var(--bg);border-radius:8px;text-align:center">
            <div style="font-size:18px;font-weight:800;color:var(--purple)" id="roi-hours">0h</div>
            <div style="font-size:8px;text-transform:uppercase;color:var(--muted);margin-top:2px">Forge Hours Worked</div>
          </div>
          <div style="padding:8px;background:var(--bg);border-radius:8px;text-align:center">
            <div style="font-size:18px;font-weight:800;color:var(--amber)" id="roi-hequiv">0h</div>
            <div style="font-size:8px;text-transform:uppercase;color:var(--muted);margin-top:2px">Human Equiv. Hours</div>
          </div>
          <div style="padding:8px;background:var(--bg);border-radius:8px;text-align:center">
            <div style="font-size:18px;font-weight:800;color:var(--blue)" id="roi-tasks">0</div>
            <div style="font-size:8px;text-transform:uppercase;color:var(--muted);margin-top:2px">Tasks Completed</div>
          </div>
        </div>
        <div style="margin-top:8px;font-size:9px;color:var(--muted);text-align:center" id="roi-note">Based on $25/hr human VA equivalent</div>
      </div>

      <!-- Completion Analytics -->
      <div class="card">
        <h2 style="font-size:12px;margin-bottom:10px">ğŸ“Š Completion History</h2>
        <div id="ct-history"><div class="empty" style="font-size:11px">Loading...</div></div>
      </div>
    </div>

    <!-- Time Split Bar -->
    <div style="padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px;margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <span style="font-size:10px;font-weight:700;color:var(--muted)">TIME SPLIT TODAY</span>
        <span style="font-size:10px;color:var(--muted)" id="ct-split-label">â€”</span>
      </div>
      <div style="display:flex;height:10px;border-radius:5px;overflow:hidden;background:var(--bg)">
        <div id="ct-split-anton" style="height:100%;background:var(--amber);transition:width .4s" title="Anton's input time"></div>
        <div id="ct-split-forge" style="height:100%;background:var(--green);transition:width .4s" title="Forge's work time"></div>
      </div>
      <div style="display:flex;gap:12px;margin-top:4px;font-size:9px;color:var(--muted)">
        <span>ğŸŸ¡ Anton's input</span><span>ğŸŸ¢ Forge's output</span><span>â¬› Human equivalent saved</span>
      </div>
    </div>

    <!-- Task Lists -->
    <div id="ct-members"></div>
  </div>

  <!-- ===== TEAM ===== -->
  <div class="page" id="p-team">
    <div class="hl hl-p" style="margin-bottom:16px">
      <h3 style="font-size:14px;margin-bottom:4px">ğŸ‘¥ Team Roster</h3>
      <p style="font-size:11px;color:var(--muted)">Current team + planned hires. Updates automatically when Forge onboards new agents.</p>
    </div>
    <div class="grid g2" style="margin-bottom:16px">
      <div class="card" style="text-align:center"><div class="sl">Active Members</div><div class="sv green" id="tm-active">0</div></div>
      <div class="card" style="text-align:center"><div class="sl">Planned Hires</div><div class="sv amber" id="tm-planned">0</div></div>
    </div>

    <!-- ORG TREE DIAGRAM -->
    <div class="card" style="margin-bottom:16px;overflow-x:auto">
      <h2>ğŸŒ³ Organisation Tree</h2>
      <div id="org-tree" style="display:flex;flex-direction:column;align-items:center;gap:0;padding:20px 0;min-width:600px"></div>
    </div>

    <div class="card">
      <h2>ğŸ¢ Team</h2>
      <table>
        <thead><tr><th>Status</th><th>Name</th><th>Role</th><th>Type</th><th>Since</th><th>Responsibilities</th></tr></thead>
        <tbody id="tm-table"><tr><td colspan="6" class="empty">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ===== KPI TARGETS ===== -->
  <div class="page" id="p-kpi">
    <div class="hl hl-p" style="margin-bottom:16px">
      <h3 style="font-size:14px;margin-bottom:4px">ğŸ¯ Weekly KPI Targets</h3>
      <p style="font-size:11px;color:var(--muted)" id="kpi-week">Week of â€”</p>
    </div>
    <div id="kpi-departments"></div>
  </div>

  <!-- ===== ROADMAP ===== -->
  <div class="page" id="p-roadmap">
    <div class="grid g2">
      <div class="card">
        <h2>ğŸ“Œ This Week</h2>
        <p style="font-size:10px;color:var(--muted);margin-bottom:10px" id="rm-thisweek">â€”</p>
        <div id="rm-this"></div>
      </div>
      <div class="card">
        <h2>ğŸ”® Next Week</h2>
        <p style="font-size:10px;color:var(--muted);margin-bottom:10px" id="rm-nextweek">â€”</p>
        <div id="rm-next"></div>
      </div>
    </div>
  </div>

  <!-- ===== TASK LOG ===== -->
  <div class="page" id="p-tasklog">
    <div class="card">
      <h2>âš¡ Forge Activity Feed</h2>
      <p style="font-size:10px;color:var(--muted);margin-bottom:12px">Real-time log of what Forge is working on. Most recent first.</p>
      <table>
        <thead><tr><th>Status</th><th>Task</th><th>Owner</th><th>Started</th><th>Finished</th><th>Duration</th></tr></thead>
        <tbody id="tl-table"><tr><td colspan="6" class="empty">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ===== SETTINGS ===== -->
  <div class="page" id="p-settings">
    <div class="grid g2">
      <div class="card">
        <h2>âš™ï¸ Company Settings</h2>
        <div class="fg">
          <div class="fg-item"><label>Company</label><input id="s-company" value="Anton Empire"></div>
          <div class="fg-item"><label>Currency</label><select id="s-cur"><option value="$">USD ($)</option><option value="Â£">GBP (Â£)</option><option value="â‚¬">EUR (â‚¬)</option></select></div>
          <div class="fg-item"><label>Tax Rate (%)</label><input type="number" id="s-tax" value="20"></div>
          <div class="fg-item"><label>Target Margin (%)</label><input type="number" id="s-margin" value="20"></div>
          <div class="fg-item fw"><button onclick="saveSettings()">Save</button></div>
        </div>
      </div>
      <div class="card">
        <h2>ğŸ—„ Data</h2>
        <p style="font-size:11px;color:var(--muted);margin-bottom:10px">Data auto-syncs from company-data.json (maintained by Forge). Manual entries also saved locally.</p>
        <div style="display:flex;gap:5px;flex-wrap:wrap">
          <button class="btn-s btn-o" onclick="exportAll()">ğŸ“¥ CSV</button>
          <button class="btn-s btn-o" onclick="exportJSON()">ğŸ’¾ JSON</button>
          <button class="btn-s btn-o" onclick="importJSON()">ğŸ“‚ Import</button>
          <button class="btn-s btn-o" onclick="loadFromJSON()">ğŸ”„ Re-sync</button>
          <button class="btn-s btn-r" onclick="resetAll()">ğŸ—‘ Reset</button>
        </div>
        <input type="file" id="impFile" accept=".json" style="display:none" onchange="handleImport(event)">
      </div>
    </div>
  </div>

  <!-- ===== BACKUP & RECOVERY ===== -->
  <div class="page" id="p-backup">
    <div class="alert" style="background:rgba(255,77,106,.06);border:1px solid rgba(255,77,106,.2);border-radius:12px;padding:20px;margin-bottom:16px">
      <h3 style="color:#ff4d6a;margin-bottom:8px">ğŸ†˜ Emergency Recovery â€” If Forge Goes Down</h3>
      <p style="font-size:12px;color:var(--muted)">Download these files, follow the steps below, and Forge comes back online in 15 minutes. <strong>No coding knowledge needed.</strong></p>
    </div>

    <div class="grid g2">
      <div class="card">
        <h2>ğŸ“¥ Core Identity Files</h2>
        <p style="font-size:11px;color:var(--muted);margin-bottom:12px">These are Forge's brain. Download and keep a copy on your phone/laptop.</p>
        <div id="backup-files" style="display:flex;flex-direction:column;gap:6px"></div>
        <button style="margin-top:12px;width:100%" onclick="downloadAllBackup()">ğŸ“¦ Download All as ZIP</button>
      </div>
      <div class="card">
        <h2>ğŸ”— Backup Locations</h2>
        <p style="font-size:11px;color:var(--muted);margin-bottom:12px">Forge exists in 3 places. If one dies, use another.</p>
        <table>
          <tr><td>ğŸŸ¢ <strong>GitHub (Primary)</strong></td><td><a href="https://github.com/AntonUrso2811/forge-workspace" style="color:var(--accent2)" target="_blank">forge-workspace</a></td></tr>
          <tr><td>ğŸŸ¢ <strong>GitHub (Tools)</strong></td><td><a href="https://github.com/AntonUrso2811/thalyve-tools" style="color:var(--accent2)" target="_blank">thalyve-tools</a></td></tr>
          <tr><td>ğŸŸ¢ <strong>Mac (Live)</strong></td><td><code>~/.openclaw/workspace/</code></td></tr>
          <tr><td>ğŸŸ¡ <strong>This Page</strong></td><td>Download files above â†‘</td></tr>
        </table>
        <p style="font-size:10px;color:var(--muted);margin-top:8px">Auto-backup runs every 6 hours â†’ GitHub. Last backup check the <a href="https://github.com/AntonUrso2811/forge-workspace/commits/main" style="color:var(--accent2)" target="_blank">commit history</a>.</p>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h2>ğŸ”§ Step-by-Step Recovery (Dummified)</h2>
      <div style="font-size:12px;line-height:1.8">
        <p><strong style="color:var(--accent2)">Scenario 1: Forge not responding but Mac is on</strong></p>
        <ol style="margin-left:16px;margin-bottom:16px">
          <li>Open <strong>Terminal</strong> (Cmd+Space â†’ type "Terminal" â†’ Enter)</li>
          <li>Paste: <code style="background:var(--bg);padding:2px 8px;border-radius:4px">openclaw gateway restart</code> â†’ press Enter</li>
          <li>Wait 30 seconds â†’ send message on Telegram</li>
          <li>If still nothing â†’ type <code>/restart</code> in Telegram</li>
        </ol>

        <p><strong style="color:var(--accent2)">Scenario 2: "Provider in cooldown" error</strong></p>
        <ol style="margin-left:16px;margin-bottom:16px">
          <li>In Terminal: <code style="background:var(--bg);padding:2px 8px;border-radius:4px">openclaw gateway stop</code></li>
          <li>Then: <code style="background:var(--bg);padding:2px 8px;border-radius:4px">nano ~/.openclaw/auth-profiles.json</code></li>
          <li>Find <code>cooldownUntil</code> â†’ delete that line</li>
          <li>Find <code>errorCount</code> â†’ change to <code>0</code></li>
          <li>Save: <strong>Ctrl+O â†’ Enter â†’ Ctrl+X</strong></li>
          <li>Then: <code style="background:var(--bg);padding:2px 8px;border-radius:4px">openclaw gateway start</code></li>
        </ol>

        <p><strong style="color:var(--accent2)">Scenario 3: Everything is broken â€” full rebuild</strong></p>
        <ol style="margin-left:16px;margin-bottom:16px">
          <li><code style="background:var(--bg);padding:2px 8px;border-radius:4px">npm uninstall -g openclaw</code></li>
          <li><code style="background:var(--bg);padding:2px 8px;border-radius:4px">npm install -g openclaw</code></li>
          <li><code style="background:var(--bg);padding:2px 8px;border-radius:4px">openclaw onboard</code> â†’ follow the wizard</li>
          <li><code style="background:var(--bg);padding:2px 8px;border-radius:4px">cd ~/.openclaw && git clone https://github.com/AntonUrso2811/forge-workspace.git workspace</code></li>
          <li><code style="background:var(--bg);padding:2px 8px;border-radius:4px">openclaw gateway start</code></li>
          <li>Forge is back. All memory restored. ~15 minutes total.</li>
        </ol>

        <p><strong style="color:var(--accent2)">Scenario 4: Forge responds but lost memory</strong></p>
        <ol style="margin-left:16px;margin-bottom:16px">
          <li>Tell Forge: <em>"Read SOUL.md, USER.md, MEMORY.md, and memory/2026-02-26.md"</em></li>
          <li>Forge reloads everything from files. Full context restored.</li>
        </ol>

        <p><strong style="color:var(--accent2)">Scenario 5: Usage cap hit â€” Forge goes silent</strong></p>
        <ol style="margin-left:16px;margin-bottom:16px">
          <li>Check: <a href="https://console.anthropic.com" style="color:var(--accent2)" target="_blank">console.anthropic.com</a></li>
          <li>If usage is at limit â†’ wait for reset OR upgrade plan</li>
          <li>This is NOT a bug â€” just the subscription allowance running out</li>
        </ol>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h2>ğŸ“‹ Incident Log</h2>
      <table>
        <tr><th>Date</th><th>Issue</th><th>Cause</th><th>Fix</th></tr>
        <tr><td>Feb 25</td><td>Gateway crash loop + workspace wiped</td><td>OAuth 403 â†’ cooldown loop</td><td>Reinstall + rebuild from Telegram</td></tr>
        <tr><td>Feb 25</td><td>Telegram not receiving replies</td><td>Webchat hijacking routing</td><td>Close webchat tabs + dmScope fix</td></tr>
        <tr><td>Feb 26</td><td>"Typing" but no response</td><td>Session too long (20+ voice notes)</td><td>/restart in Telegram</td></tr>
      </table>
      <p style="font-size:10px;color:var(--muted);margin-top:8px">This log is updated by Forge every time an incident occurs.</p>
    </div>
  </div>

  <div class="wm">ğŸ”± Anton Empire Command Centre v3.2 â€¢ Data: company-data.json (Forge-maintained) + local edits â€¢ Built by Forge</div>
</div>
<div class="toast" id="toast"></div>

<script>
const D={
  company: JSON.parse(localStorage.getItem('ae2_company')||'{"name":"Anton Empire","currency":"$","taxRate":20,"targetNetMargin":20}'),
  companyExpenses: JSON.parse(localStorage.getItem('ae2_companyExpenses')||'[]'),
  brands: JSON.parse(localStorage.getItem('ae2_brands')||'[]'),
  daily: JSON.parse(localStorage.getItem('ae2_daily')||'[]')
};
function sv(k){if(k)localStorage.setItem('ae2_'+k,JSON.stringify(D[k]));else['company','companyExpenses','brands','daily'].forEach(k=>localStorage.setItem('ae2_'+k,JSON.stringify(D[k])))}

function nav(id,el){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.getElementById('p-'+id).classList.add('active');el.classList.add('active')}

// ===== EXPENSES =====
function addExpense(){
  const n=document.getElementById('e-name').value.trim();const a=parseFloat(document.getElementById('e-amt').value)||0;
  if(!n||!a){toast('Fill name & amount',1);return}
  D.companyExpenses.push({id:Date.now().toString(36),name:n,category:document.getElementById('e-cat').value,amount:a,frequency:document.getElementById('e-freq').value,date:document.getElementById('e-date').value||new Date().toISOString().split('T')[0],notes:document.getElementById('e-notes').value});
  sv('companyExpenses');render();document.getElementById('e-name').value='';document.getElementById('e-amt').value='';document.getElementById('e-notes').value='';toast('Expense added');
}
function delExp(id){D.companyExpenses=D.companyExpenses.filter(e=>e.id!==id);sv('companyExpenses');render()}

// ===== DAILY =====
function addDaily(){
  const date=document.getElementById('d-date').value;if(!date){toast('Pick date',1);return}
  const brandId=document.getElementById('d-brand').value;
  const prodId=document.getElementById('d-prod').value;
  const orders=parseInt(document.getElementById('d-orders').value)||0;
  const adSpend=parseFloat(document.getElementById('d-ads').value)||0;
  const brand=D.brands.find(b=>b.id===brandId);
  const prod=brand?brand.products.find(p=>p.id===prodId):null;
  let rev=parseFloat(document.getElementById('d-rev').value);
  if(isNaN(rev)&&prod)rev=prod.price*orders;else if(isNaN(rev))rev=0;
  const cogs=prod?(prod.cogs+prod.shipping)*orders:0;
  D.daily.push({id:Date.now().toString(36),date,brandId,brandName:brand?brand.name:'?',productId:prodId,productName:prod?prod.name:'?',orders,revenue:rev,adSpend,cogs});
  D.daily.sort((a,b)=>a.date.localeCompare(b.date));
  sv('daily');render();
  document.getElementById('d-orders').value='0';document.getElementById('d-ads').value='0';document.getElementById('d-rev').value='';
  toast('Entry added');
}
function delDaily(id){D.daily=D.daily.filter(e=>e.id!==id);sv('daily');render()}

// ===== SETTINGS =====
function saveSettings(){
  D.company={name:document.getElementById('s-company').value,currency:document.getElementById('s-cur').value,taxRate:parseFloat(document.getElementById('s-tax').value)||20,targetNetMargin:parseFloat(document.getElementById('s-margin').value)||20};
  sv('company');render();toast('Saved');
}

// ===== RENDER =====
function render(){
  const c=D.company.currency||'$';
  const f=n=>(n>=0?c:'-'+c)+Math.abs(n).toFixed(2);

  // Expense calcs
  const mRecur=D.companyExpenses.filter(e=>e.frequency==='monthly').reduce((s,e)=>s+e.amount,0);
  const aRecur=D.companyExpenses.filter(e=>e.frequency==='annual').reduce((s,e)=>s+e.amount/12,0);
  const once=D.companyExpenses.filter(e=>e.frequency==='one-time').reduce((s,e)=>s+e.amount,0);
  const totalOpex=mRecur+aRecur+once;

  // Daily totals
  const totRev=D.daily.reduce((s,e)=>s+e.revenue,0);
  const totAds=D.daily.reduce((s,e)=>s+e.adSpend,0);
  const totCogs=D.daily.reduce((s,e)=>s+e.cogs,0);
  const totOrders=D.daily.reduce((s,e)=>s+e.orders,0);
  const grossProfit=totRev-totCogs;
  const preTax=grossProfit-totAds-totalOpex;
  const taxEst=preTax>0?preTax*(D.company.taxRate||20)/100:0;
  const netProfit=preTax-taxEst;
  const roas=totAds>0?totRev/totAds:0;

  // Overview KPIs
  document.getElementById('o-rev').textContent=f(totRev);
  document.getElementById('o-orders').textContent=totOrders+' orders';
  document.getElementById('o-ads').textContent=f(totAds);
  document.getElementById('o-adpct').textContent=totRev>0?(totAds/totRev*100).toFixed(1)+'% of revenue':'â€”';
  document.getElementById('o-cogs').textContent=f(totCogs);
  document.getElementById('o-cogspct').textContent=totRev>0?(totCogs/totRev*100).toFixed(1)+'% of revenue':'â€”';
  document.getElementById('o-opex').textContent=f(totalOpex);
  document.getElementById('o-opexn').textContent=D.companyExpenses.length+' items';
  document.getElementById('o-tax').textContent=f(taxEst);
  document.getElementById('o-taxr').textContent=(D.company.taxRate||20)+'% of pre-tax profit';
  const onEl=document.getElementById('o-net');onEl.textContent=f(netProfit);onEl.className='sv '+(netProfit>=0?'green':'red');
  document.getElementById('o-netm').textContent=totRev>0?(netProfit/totRev*100).toFixed(1)+'% net margin':'â€”';
  document.getElementById('o-netm').className='ss '+(netProfit>=0?'green':'red');

  // P&L
  document.getElementById('pl-rev').textContent=f(totRev);
  document.getElementById('pl-cogs').textContent=f(totCogs);
  document.getElementById('pl-gross').textContent=f(grossProfit);document.getElementById('pl-gross').className='pl-sep '+(grossProfit>=0?'green':'red');
  document.getElementById('pl-ads').textContent=f(totAds);
  document.getElementById('pl-opex').textContent=f(totalOpex);
  document.getElementById('pl-pretax').textContent=f(preTax);document.getElementById('pl-pretax').className='pl-sep '+(preTax>=0?'green':'red');
  document.getElementById('pl-tax').textContent=f(taxEst);
  const plN=document.getElementById('pl-net');plN.textContent=f(netProfit);plN.className='pl-total '+(netProfit>=0?'green':'red');

  // Brand summary table
  const obr=document.getElementById('o-brands');
  if(D.brands.length===0){obr.innerHTML='<tr><td colspan="8" class="empty">No brands</td></tr>';}
  else{
    obr.innerHTML=D.brands.map(b=>{
      const bd=D.daily.filter(d=>d.brandId===b.id);
      const br=bd.reduce((s,d)=>s+d.revenue,0),bo=bd.reduce((s,d)=>s+d.orders,0),ba=bd.reduce((s,d)=>s+d.adSpend,0),bc=bd.reduce((s,d)=>s+d.cogs,0);
      const bp=br-ba-bc,bm=br>0?(bp/br*100).toFixed(1):'0',broas=ba>0?(br/ba).toFixed(2):'â€”';
      return`<tr><td><strong>${b.name}</strong></td><td class="green">${f(br)}</td><td>${bo}</td><td class="red">${f(ba)}</td><td>${f(bc)}</td><td class="${bp>=0?'green':'red'}">${f(bp)}</td><td>${broas}x</td><td class="${parseFloat(bm)>=0?'green':'red'}">${bm}%</td></tr>`;
    }).join('');
  }

  // 7-day chart
  const dates=[...new Set(D.daily.map(d=>d.date))].sort().slice(-7);
  const oc=document.getElementById('o-chart');
  if(!dates.length){oc.innerHTML='<div class="empty">Add daily entries to see trends</div>';}
  else{
    const dd=dates.map(dt=>{const e=D.daily.filter(d=>d.date===dt);return{date:dt,rev:e.reduce((s,d)=>s+d.revenue,0),prof:e.reduce((s,d)=>s+(d.revenue-d.adSpend-d.cogs),0)};});
    const mx=Math.max(...dd.map(d=>d.rev),1);
    oc.innerHTML=dd.map(d=>{const dt=new Date(d.date+'T12:00:00');const l=dt.toLocaleDateString('en-GB',{day:'numeric',month:'short'});return`<div class="chart-row"><div class="chart-lbl">${l}</div><div class="chart-bg"><div class="chart-bar" style="width:${(d.rev/mx*100).toFixed(1)}%;background:linear-gradient(90deg,var(--accent),var(--accent2))">${f(d.rev)}</div></div><div style="width:50px;text-align:right;font-size:10px;font-weight:600" class="${d.prof>=0?'green':'red'}">${d.prof>=0?'+':''}${f(d.prof)}</div></div>`;}).join('');
  }

  // ===== BRAND PAGE (THALYVE) =====
  const tb=D.brands.find(b=>b.id==='thalyve');
  if(tb){
    const td=D.daily.filter(d=>d.brandId==='thalyve');
    const tr=td.reduce((s,d)=>s+d.revenue,0),to=td.reduce((s,d)=>s+d.orders,0),ta=td.reduce((s,d)=>s+d.adSpend,0),tc=td.reduce((s,d)=>s+d.cogs,0);
    const tp=tr-ta-tc;
    document.getElementById('b-rev').textContent=f(tr);document.getElementById('b-orders').textContent=to+' orders';
    document.getElementById('b-ads').textContent=f(ta);
    document.getElementById('b-cogs').textContent=f(tc);
    const bpEl=document.getElementById('b-profit');bpEl.textContent=f(tp);bpEl.className='sv '+(tp>=0?'green':'red');
    document.getElementById('b-margin').textContent=tr>0?(tp/tr*100).toFixed(1)+'% margin':'â€”';
    document.getElementById('b-margin').className='ss '+(tp>=0?'green':'red');
    const br=ta>0?(tr/ta):0;document.getElementById('b-roas').textContent=br.toFixed(2)+'x';
    document.getElementById('b-roast').textContent=br>=2?'ğŸŸ¢ Strong':br>=1?'ğŸŸ¡ Break-even':td.length?'ğŸ”´ Below BE':'â€”';
    const bcpa=to>0?ta/to:0;document.getElementById('b-cpa').textContent=f(bcpa);
    document.getElementById('b-cpat').textContent=bcpa>0?(bcpa<20?'ğŸŸ¢ Strong':bcpa<30?'ğŸŸ¡ Watch':'ğŸ”´ High'):'â€”';
    document.getElementById('b-adleft').textContent=f(1000-ta);

    // Product cards
    const bpt=document.getElementById('b-prods');
    const bpc=document.getElementById('b-prods-cards');
    bpt.innerHTML=tb.products.map(p=>{
      const fee=p.price*p.txnFee/100;const m=p.price-p.cogs-p.shipping-fee;const pct=p.price>0?(m/p.price*100):0;
      const pd=td.filter(d=>d.productId===p.id);const po=pd.reduce((s,d)=>s+d.orders,0);const pr=pd.reduce((s,d)=>s+d.revenue,0);
      return`<tr><td>${p.name}<br><span style="color:var(--muted);font-size:9px">${p.sku}</span></td><td>${c}${p.price}</td><td>${c}${p.cogs}</td><td class="${pct>=0?'green':'red'}">${pct.toFixed(1)}%</td><td class="amber">${f(m)}</td><td>${po}</td><td class="green">${f(pr)}</td></tr>`;
    }).join('');
    if(bpc){
      bpc.innerHTML=tb.products.map(p=>{
        const fee=p.price*p.txnFee/100;const m=p.price-p.cogs-p.shipping-fee;const pct=p.price>0?(m/p.price*100):0;
        const pd=td.filter(d=>d.productId===p.id);const po=pd.reduce((s,d)=>s+d.orders,0);const pr=pd.reduce((s,d)=>s+d.revenue,0);
        const marginColor=pct>=70?'var(--green)':pct>=50?'var(--amber)':'var(--red)';
        return`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--bg);border-radius:8px;margin-bottom:6px">
          <div style="flex:1">
            <div style="font-size:12px;font-weight:700">${p.name}</div>
            <div style="font-size:9px;color:var(--muted)">${p.sku}</div>
          </div>
          <div style="display:flex;gap:16px;align-items:center;text-align:center">
            <div><div style="font-size:12px;font-weight:700">${c}${p.price}</div><div style="font-size:8px;color:var(--muted)">PRICE</div></div>
            <div><div style="font-size:12px;font-weight:700">${c}${p.cogs}</div><div style="font-size:8px;color:var(--muted)">COGS</div></div>
            <div><div style="font-size:12px;font-weight:700;color:${marginColor}">${pct.toFixed(0)}%</div><div style="font-size:8px;color:var(--muted)">MARGIN</div></div>
            <div><div style="font-size:12px;font-weight:700;color:var(--amber)">${f(m)}</div><div style="font-size:8px;color:var(--muted)">MAX CPA</div></div>
            <div><div style="font-size:12px;font-weight:700">${po}</div><div style="font-size:8px;color:var(--muted)">ORDERS</div></div>
          </div>
        </div>`;
      }).join('');
    }

    // Brand chart
    const bc2=document.getElementById('b-chart');
    const bdates=[...new Set(td.map(d=>d.date))].sort().slice(-7);
    if(!bdates.length){bc2.innerHTML='<div class="empty">No data yet</div>';}
    else{
      const bdd=bdates.map(dt=>{const e=td.filter(d=>d.date===dt);return{date:dt,rev:e.reduce((s,d)=>s+d.revenue,0),prof:e.reduce((s,d)=>s+(d.revenue-d.adSpend-d.cogs),0)};});
      const bmx=Math.max(...bdd.map(d=>d.rev),1);
      bc2.innerHTML=bdd.map(d=>{const dt=new Date(d.date+'T12:00:00');const l=dt.toLocaleDateString('en-GB',{day:'numeric',month:'short'});return`<div class="chart-row"><div class="chart-lbl">${l}</div><div class="chart-bg"><div class="chart-bar" style="width:${(d.rev/bmx*100).toFixed(1)}%;background:linear-gradient(90deg,var(--green),var(--teal))">${f(d.rev)}</div></div><div style="width:50px;text-align:right;font-size:10px;font-weight:600" class="${d.prof>=0?'green':'red'}">${d.prof>=0?'+':''}${f(d.prof)}</div></div>`;}).join('');
    }
  }

  // ===== EXPENSES TABLE =====
  const et=document.getElementById('e-table');
  if(!D.companyExpenses.length){et.innerHTML='<tr><td colspan="5" class="empty">No expenses</td></tr>';}
  else{et.innerHTML=D.companyExpenses.map(e=>`<tr><td>${e.name}</td><td>${e.category}</td><td>${c}${e.amount.toFixed(2)}</td><td>${e.frequency}</td><td><button class="btn-s btn-r" onclick="delExp('${e.id}')">âœ•</button></td></tr>`).join('');}
  document.getElementById('e-recur').textContent=f(mRecur+aRecur);
  document.getElementById('e-once').textContent=f(once);
  document.getElementById('e-burn').textContent=f(totalOpex);

  // ===== DAILY TABLE + SUMMARY =====
  const dt2=document.getElementById('d-table');
  if(!D.daily.length){dt2.innerHTML='<tr><td colspan="10" class="empty">No entries yet â€” log your first day or wait for automation ğŸš€</td></tr>';}
  else{dt2.innerHTML=D.daily.sort((a,b)=>b.date.localeCompare(a.date)).map(e=>{const p=e.revenue-e.adSpend-e.cogs;const r=e.adSpend>0?(e.revenue/e.adSpend).toFixed(2):'â€”';return`<tr><td>${new Date(e.date+'T12:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</td><td>${e.brandName}</td><td>${e.productName}</td><td>${e.orders}</td><td class="green">${f(e.revenue)}</td><td class="red">${f(e.adSpend)}</td><td>${f(e.cogs)}</td><td class="${p>=0?'green':'red'}">${f(p)}</td><td>${r}x</td><td><button class="btn-s btn-r" onclick="delDaily('${e.id}')">âœ•</button></td></tr>`;}).join('');}
  // Daily log summary cards
  const dlRev=D.daily.reduce((s,d)=>s+d.revenue,0);
  const dlAds=D.daily.reduce((s,d)=>s+d.adSpend,0);
  const dlCogs=D.daily.reduce((s,d)=>s+d.cogs,0);
  const dlOrd=D.daily.reduce((s,d)=>s+d.orders,0);
  const dlProf=dlRev-dlAds-dlCogs;
  const dlEl=id=>document.getElementById(id);
  if(dlEl('dl-rev'))dlEl('dl-rev').textContent=f(dlRev);
  if(dlEl('dl-ads'))dlEl('dl-ads').textContent=f(dlAds);
  if(dlEl('dl-profit')){dlEl('dl-profit').textContent=f(dlProf);dlEl('dl-profit').style.color=dlProf>=0?'var(--green)':'var(--red)';}
  if(dlEl('dl-roas'))dlEl('dl-roas').textContent=(dlAds>0?(dlRev/dlAds):0).toFixed(2)+'x';
  if(dlEl('dl-orders'))dlEl('dl-orders').textContent=dlOrd;
  if(dlEl('dl-count'))dlEl('dl-count').textContent=D.daily.length+' entries';
  // Daily log mini chart
  const dlChart=dlEl('dl-chart');
  if(dlChart&&D.daily.length){
    const dates=[...new Set(D.daily.map(d=>d.date))].sort().slice(-7);
    if(dlEl('dl-period'))dlEl('dl-period').textContent=dates.length>1?new Date(dates[0]+'T12:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'})+' â€” '+new Date(dates[dates.length-1]+'T12:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'}):'';
    const dd=dates.map(dt=>{const e=D.daily.filter(d=>d.date===dt);return{date:dt,rev:e.reduce((s,d)=>s+d.revenue,0),spend:e.reduce((s,d)=>s+d.adSpend,0),prof:e.reduce((s,d)=>s+(d.revenue-d.adSpend-d.cogs),0)};});
    const mx=Math.max(...dd.map(d=>Math.max(d.rev,d.spend)),1);
    dlChart.innerHTML=dd.map(d=>{const l=new Date(d.date+'T12:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'});return`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
      <div style="width:50px;font-size:10px;color:var(--muted);text-align:right;flex-shrink:0">${l}</div>
      <div style="flex:1;display:flex;flex-direction:column;gap:2px">
        <div style="height:12px;background:var(--bg);border-radius:3px;overflow:hidden"><div style="height:100%;width:${(d.rev/mx*100).toFixed(1)}%;background:linear-gradient(90deg,var(--green),var(--teal));border-radius:3px;display:flex;align-items:center;padding-left:4px;font-size:8px;font-weight:700;color:#fff">${d.rev>0?f(d.rev):''}</div></div>
        <div style="height:8px;background:var(--bg);border-radius:3px;overflow:hidden"><div style="height:100%;width:${(d.spend/mx*100).toFixed(1)}%;background:linear-gradient(90deg,var(--red),#ef4444);border-radius:3px"></div></div>
      </div>
      <div style="width:55px;text-align:right;font-size:10px;font-weight:700;flex-shrink:0" class="${d.prof>=0?'green':'red'}">${d.prof>=0?'+':''}${f(d.prof)}</div>
    </div>`;}).join('')+'<div style="display:flex;gap:12px;justify-content:center;margin-top:8px;font-size:9px;color:var(--muted)"><span>ğŸŸ¢ Revenue</span><span>ğŸ”´ Ad Spend</span><span>Â± Net Profit</span></div>';
  }

  // Dropdowns
  const bs=document.getElementById('d-brand');
  bs.innerHTML=D.brands.map(b=>`<option value="${b.id}">${b.name}</option>`).join('')||'<option>No brands</option>';
  updateProdDropdown();
}

function updateProdDropdown(){
  const bid=document.getElementById('d-brand').value;
  const b=D.brands.find(br=>br.id===bid);
  const ps=document.getElementById('d-prod');
  ps.innerHTML=b?b.products.map(p=>`<option value="${p.id}">${p.name} â€” ${D.company.currency}${p.price}</option>`).join(''):'<option>â€”</option>';
}

// ===== JSON SYNC =====
async function loadFromJSON(){
  try{
    const r=await fetch('company-data.json?t='+Date.now());if(!r.ok)return;
    const j=await r.json();
    if(j.company)D.company={...D.company,...j.company};
    if(j.companyExpenses&&j.companyExpenses.length){
      j.companyExpenses.forEach(ne=>{if(!D.companyExpenses.find(e=>e.id===ne.id))D.companyExpenses.push(ne);});
    }
    if(j.brands&&j.brands.length){
      j.brands.forEach(nb=>{
        const ex=D.brands.find(b=>b.id===nb.id);
        if(ex){ex.products=nb.products;ex.mediaBuying=nb.mediaBuying;ex.status=nb.status;}
        else D.brands.push(nb);
        if(nb.daily&&nb.daily.length){nb.daily.forEach(nd=>{if(!D.daily.find(d=>d.id===nd.id)){nd.brandId=nb.id;nd.brandName=nb.name;D.daily.push(nd);}});}
      });
    }
    if(j.taxes)D.company.taxRate=j.taxes.estimatedRate||D.company.taxRate;
    sv();
    document.getElementById('s-company').value=D.company.name;
    document.getElementById('s-cur').value=D.company.currency;
    document.getElementById('s-tax').value=D.company.taxRate;
    document.getElementById('s-margin').value=D.company.targetNetMargin;
    document.getElementById('lastSync').textContent='Synced '+ new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    _jsonData=j;
    // Merge localStorage task completions
    const savedTasks=JSON.parse(localStorage.getItem('ae2_criticalTasks')||'null');
    if(savedTasks&&savedTasks.date===j.dailyCriticalTasks?.date&&savedTasks.members){j.dailyCriticalTasks=savedTasks;}
    renderCriticalTasks(j);renderTeam(j);renderKPI(j);renderRoadmap(j);renderTaskLog(j);
    render();toast('Synced from Forge');
  }catch(e){}
}

// ===== EXPORT =====
function exportAll(){
  let csv='Date,Brand,Product,Orders,Revenue,Ad Spend,COGS,Profit,ROAS\n';
  D.daily.forEach(e=>{const p=e.revenue-e.adSpend-e.cogs;csv+=`${e.date},"${e.brandName}","${e.productName}",${e.orders},${e.revenue.toFixed(2)},${e.adSpend.toFixed(2)},${e.cogs.toFixed(2)},${p.toFixed(2)},${e.adSpend>0?(e.revenue/e.adSpend).toFixed(2):'0'}\n`;});
  dl('anton-empire-daily.csv',csv,'text/csv');toast('Exported');
}
function exportJSON(){dl('anton-empire-backup.json',JSON.stringify(D,null,2),'application/json');toast('Backup saved');}
function importJSON(){document.getElementById('impFile').click();}
function handleImport(ev){
  const f=ev.target.files[0];if(!f)return;const r=new FileReader();
  r.onload=function(e){try{const d=JSON.parse(e.target.result);if(d.company)D.company=d.company;if(d.companyExpenses)D.companyExpenses=d.companyExpenses;if(d.brands)D.brands=d.brands;if(d.daily)D.daily=d.daily;sv();render();toast('Imported');}catch(e){toast('Bad file',1);}};
  r.readAsText(f);
}
function resetAll(){if(confirm('Delete ALL data?')){D.companyExpenses=[];D.brands=[];D.daily=[];sv();render();toast('Reset');}}
function dl(n,c,t){const b=new Blob([c],{type:t});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click();}
function toast(m,e){const t=document.getElementById('toast');t.textContent=m;t.style.background=e?'var(--red)':'var(--green)';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// ===== KPI / ROADMAP / TASKLOG RENDER =====
function renderCriticalTasks(data){
  if(!data||!data.dailyCriticalTasks)return;
  const ct=data.dailyCriticalTasks;
  const dateEl=document.getElementById('ct-date');
  if(dateEl){const d=new Date(ct.date+'T12:00:00');dateEl.textContent=d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});}
  const container=document.getElementById('ct-members');
  let totalTasks=0,totalDone=0;

  // Merge localStorage completions
  const saved=JSON.parse(localStorage.getItem('ae2_criticalTasks')||'null');
  if(saved&&saved.date===ct.date&&saved.members){
    Object.keys(saved.members).forEach(k=>{
      if(ct.members[k]&&saved.members[k]){
        saved.members[k].tasks.forEach((st,i)=>{if(ct.members[k].tasks[i])ct.members[k].tasks[i].done=st.done;});
      }
    });
  }

  container.innerHTML=Object.keys(ct.members).map(key=>{
    const m=ct.members[key];
    const done=m.tasks.filter(t=>t.done).length;
    totalTasks+=m.tasks.length;totalDone+=done;
    const pct=Math.round(done/m.tasks.length*100);
    const color=pct>=100?'var(--green)':pct>=60?'var(--amber)':'var(--red)';
    const rows=m.tasks.map((t,i)=>{
      const pri=t.task.startsWith('ğŸ”´')?'border-left:3px solid var(--red);':t.task.startsWith('ğŸŸ¡')?'border-left:3px solid var(--amber);':'border-left:3px solid var(--green);';
      return`<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:4px;background:${t.done?'rgba(76,175,80,0.04)':'var(--bg)'};border-radius:8px;${pri}cursor:pointer;transition:all .2s" onclick="toggleTask('${key}',${i})">
        <span style="font-size:18px;flex-shrink:0">${t.done?'âœ…':'â¬œ'}</span>
        <span style="flex:1;font-size:12px;${t.done?'text-decoration:line-through;color:var(--muted)':'font-weight:500'}">${t.task}</span>
        ${t.done?'<span style="font-size:9px;color:var(--green);font-weight:600">DONE</span>':''}
      </div>`;
    }).join('');
    return`<div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h2 style="margin:0;font-size:14px">${m.name}</h2>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:12px;font-weight:800;color:${color}">${done}/${m.tasks.length}</span>
          <div style="width:60px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden">
            <div style="height:100%;width:${pct}%;background:${color};border-radius:3px;transition:width .3s"></div>
          </div>
        </div>
      </div>
      ${rows}
    </div>`;
  }).join('');

  // Overall progress ring
  const overallPct=totalTasks>0?Math.round(totalDone/totalTasks*100):0;
  const ring=document.getElementById('ct-ring');
  if(ring){
    const circ=2*Math.PI*42;
    ring.style.strokeDasharray=circ;
    ring.style.strokeDashoffset=circ-(circ*overallPct/100);
    ring.style.stroke=overallPct>=100?'var(--green)':overallPct>=60?'var(--amber)':'var(--red)';
  }
  const oEl=document.getElementById('ct-overall');
  if(oEl)oEl.textContent=overallPct+'%';

  // ROI Tracker
  if(data.productivity){
    const p=data.productivity.totals;
    const el=id=>document.getElementById(id);
    if(el('roi-equiv'))el('roi-equiv').textContent='$'+p.humanCostEquiv.toLocaleString();
    if(el('roi-hours'))el('roi-hours').textContent=p.forgeHours+'h';
    if(el('roi-hequiv'))el('roi-hequiv').textContent=p.humanEquivHours+'h';
    if(el('roi-tasks'))el('roi-tasks').textContent=p.tasksCompleted;
    if(el('roi-since'))el('roi-since').textContent='since '+new Date(data.productivity.since+'T12:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'});
    if(el('roi-note'))el('roi-note').textContent='Based on $'+p.hourlyRate+'/hr VA rate Â· '+p.humanEquivHours+'h would cost $'+p.humanCostEquiv;

    // Time split bar (today)
    const today=data.productivity.days[data.productivity.days.length-1];
    if(today){
      const total=today.antonHours+today.forgeHours;
      if(el('ct-split-anton'))el('ct-split-anton').style.width=(today.antonHours/total*100)+'%';
      if(el('ct-split-forge'))el('ct-split-forge').style.width=(today.forgeHours/total*100)+'%';
      if(el('ct-split-label'))el('ct-split-label').textContent='Anton '+today.antonHours+'h input â†’ Forge '+today.forgeHours+'h output â†’ '+today.humanEquivHours+'h human equiv.';
    }
  }

  // Completion history chart
  if(data.taskHistory){
    const hist=document.getElementById('ct-history');
    if(hist){
      hist.innerHTML=data.taskHistory.map(d=>{
        const aTotal=d.anton.total,aDone=d.anton.done,fTotal=d.forge.total,fDone=d.forge.done;
        const allDone=aDone+fDone,allTotal=aTotal+fTotal;
        const pct=Math.round(allDone/allTotal*100);
        const dt=new Date(d.date+'T12:00:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
        const color=pct>=100?'var(--green)':pct>=60?'var(--amber)':'var(--red)';
        return`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <div style="width:70px;font-size:10px;color:var(--muted);flex-shrink:0">${dt}</div>
          <div style="flex:1;height:14px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative">
            <div style="height:100%;width:${pct}%;background:${color};border-radius:4px;transition:width .3s"></div>
            <span style="position:absolute;right:6px;top:1px;font-size:9px;font-weight:700">${allDone}/${allTotal}</span>
          </div>
          <div style="width:35px;text-align:right;font-size:11px;font-weight:800;color:${color}">${pct}%</div>
        </div>`;
      }).join('');
    }
  }
}
function toggleTask(member,idx){
  if(!_jsonData||!_jsonData.dailyCriticalTasks)return;
  const t=_jsonData.dailyCriticalTasks.members[member].tasks[idx];
  t.done=!t.done;
  renderCriticalTasks(_jsonData);
  // Save to localStorage
  localStorage.setItem('ae2_criticalTasks',JSON.stringify(_jsonData.dailyCriticalTasks));
}

function renderTeam(data){
  if(!data||!data.team)return;
  const team=data.team;
  const biz=team.filter(t=>t.domain!=='personal');
  const active=biz.filter(t=>t.status==='active');
  const planned=biz.filter(t=>t.status==='planned');
  document.getElementById('tm-active').textContent=active.length;
  document.getElementById('tm-planned').textContent=planned.length;

  // --- Org Tree Diagram ---
  const tree=document.getElementById('org-tree');
  if(tree){
    const nodeStyle=(t,big)=>{
      const isActive=t.status==='active';
      const border=isActive?'var(--green)':'var(--amber)';
      const bg=isActive?'rgba(76,175,80,0.08)':'rgba(255,193,7,0.08)';
      const icon=t.type==='human'?'ğŸ‘¤':'ğŸ¤–';
      const w=big?'180px':'140px';
      const fs=big?'13px':'11px';
      return`<div style="display:inline-flex;flex-direction:column;align-items:center;padding:${big?'14px 18px':'10px 14px'};border:2px solid ${border};border-radius:12px;background:${bg};min-width:${w};position:relative">
        <div style="font-size:${big?'22px':'16px'};margin-bottom:4px">${icon}</div>
        <div style="font-weight:700;font-size:${fs};color:var(--text)">${t.name}</div>
        <div style="font-size:${big?'10px':'9px'};color:var(--muted);text-align:center">${t.role}</div>
        <div style="margin-top:4px;font-size:9px;padding:2px 8px;border-radius:10px;background:${isActive?'var(--green)':'var(--amber)'};color:#000;font-weight:600">${isActive?'ACTIVE':'PLANNED'}</div>
      </div>`;
    };
    const line=`<div style="width:2px;height:20px;background:var(--border);margin:0 auto"></div>`;
    const hLine=`<div style="height:2px;background:var(--border);flex:1"></div>`;

    // CEO at top
    const ceo=biz.find(t=>t.id==='anton')||biz[0];
    const coo=biz.find(t=>t.id==='forge')||biz[1];
    const reports=biz.filter(t=>t.id!=='anton'&&t.id!=='forge');

    let html=nodeStyle(ceo,true);
    html+=line;
    html+=nodeStyle(coo,true);
    if(reports.length){
      html+=line;
      // horizontal connector
      html+=`<div style="display:flex;align-items:flex-start;justify-content:center;width:100%;position:relative">`;
      html+=`<div style="position:absolute;top:0;left:50%;transform:translateX(-50%);height:2px;background:var(--border);width:${Math.min(reports.length*160,800)}px"></div>`;
      html+=`</div>`;
      html+=`<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:2px">`;
      reports.forEach(t=>{
        html+=`<div style="display:flex;flex-direction:column;align-items:center">${line}${nodeStyle(t,false)}</div>`;
      });
      html+=`</div>`;
    }
    tree.innerHTML=html;
  }
  const tb=document.getElementById('tm-table');
  tb.innerHTML=biz.map(t=>{
    const icon=t.status==='active'?'ğŸŸ¢':t.status==='planned'?'ğŸŸ¡':'ğŸ”´';
    const statusColor=t.status==='active'?'green':t.status==='planned'?'amber':'red';
    const typeIcon=t.type==='human'?'ğŸ‘¤':'ğŸ¤–';
    const since=t.since?new Date(t.since).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}):'â€”';
    return`<tr>
      <td><span class="${statusColor}" style="font-weight:700">${icon} ${t.status.charAt(0).toUpperCase()+t.status.slice(1)}</span></td>
      <td style="font-weight:700">${t.name}</td>
      <td style="font-size:11px">${t.role}</td>
      <td>${typeIcon} ${t.type==='human'?'Human':'AI Agent'}</td>
      <td style="font-size:10px">${since}</td>
      <td style="font-size:10px;max-width:250px;white-space:normal;color:var(--muted)">${t.responsibilities}${t.notes?'<br><em style="color:var(--amber);font-size:9px">'+t.notes+'</em>':''}</td>
    </tr>`;
  }).join('');
}

function renderKPI(data){
  if(!data||!data.kpiTargets)return;
  const kt=data.kpiTargets;
  document.getElementById('kpi-week').textContent='Week of '+kt.weekOf;
  const container=document.getElementById('kpi-departments');
  const depts=kt.departments;
  container.innerHTML=Object.keys(depts).map(key=>{
    const dept=depts[key];
    const rows=dept.targets.map(t=>{
      const pct=t.target>0?Math.min((t.current/t.target)*100,100):0;
      const status=pct>=100?'ğŸŸ¢ Done':pct>=60?'ğŸŸ¡ On Track':'ğŸ”´ Behind';
      const barColor=pct>=100?'var(--green)':pct>=60?'var(--amber)':'var(--red)';
      return`<div style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-size:12px;font-weight:600">${t.metric}</span>
          <span style="font-size:11px;font-weight:700">${t.current}/${t.target} ${t.unit} ${status}</span>
        </div>
        <div style="height:8px;background:var(--bg);border-radius:4px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${barColor};border-radius:4px;transition:width .4s"></div>
        </div>
      </div>`;
    }).join('');
    return`<div class="card" style="margin-bottom:12px">
      <h2>${dept.name} <span style="font-size:10px;color:var(--muted);font-weight:400">Owner: ${dept.owner}</span></h2>
      ${rows}
    </div>`;
  }).join('');
}

function renderRoadmap(data){
  if(!data||!data.roadmap)return;
  const rm=data.roadmap;
  if(rm.thisWeek){
    document.getElementById('rm-thisweek').textContent='Week of '+rm.thisWeek.weekOf;
    document.getElementById('rm-this').innerHTML=rm.thisWeek.priorities.map(p=>{
      const icon=p.status==='done'?'âœ…':p.status==='in-progress'?'ğŸ”„':p.status==='blocked'?'ğŸš«':'ğŸ“‹';
      const color=p.status==='done'?'var(--green)':p.status==='in-progress'?'var(--amber)':p.status==='blocked'?'var(--red)':'var(--muted)';
      return`<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
        <span style="font-size:14px">${icon}</span>
        <div style="flex:1"><span style="font-size:12px;font-weight:500">${p.task}</span>${p.blocker?`<br><span style="font-size:9px;color:var(--red)">âš ï¸ ${p.blocker}</span>`:''}</div>
        <span style="font-size:10px;color:${color};font-weight:600;text-transform:uppercase">${p.status}</span>
        <span style="font-size:9px;color:var(--muted)">${p.owner}</span>
      </div>`;
    }).join('');
  }
  if(rm.nextWeek){
    document.getElementById('rm-nextweek').textContent='Week of '+rm.nextWeek.weekOf;
    document.getElementById('rm-next').innerHTML=rm.nextWeek.priorities.map(p=>{
      return`<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
        <span style="font-size:14px">ğŸ“‹</span>
        <div style="flex:1"><span style="font-size:12px;font-weight:500">${p.task}</span></div>
        <span style="font-size:9px;color:var(--muted)">${p.owner}</span>
      </div>`;
    }).join('');
  }
}

function renderTaskLog(data){
  if(!data||!data.taskLog)return;
  const tl=data.taskLog.slice().reverse();
  const tb=document.getElementById('tl-table');
  tb.innerHTML=tl.map(t=>{
    const icon=t.status==='done'?'âœ…':t.status==='in-progress'?'ğŸ”„':'ğŸš«';
    const sColor=t.status==='done'?'green':t.status==='in-progress'?'amber':'red';
    const started=t.started?new Date(t.started).toLocaleString('en-GB',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}):'â€”';
    const finished=t.finished?new Date(t.finished).toLocaleString('en-GB',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}):'â€”';
    let duration='â€”';
    if(t.started&&t.finished){const ms=new Date(t.finished)-new Date(t.started);duration=Math.round(ms/60000)+' min';}
    else if(t.started&&t.status==='in-progress'){const ms=Date.now()-new Date(t.started);duration=Math.round(ms/60000)+' min (active)';}
    return`<tr>
      <td><span class="${sColor}" style="font-weight:700">${icon} ${t.status}</span></td>
      <td style="font-weight:600">${t.task}</td>
      <td>${t.owner||'Forge'}</td>
      <td style="font-size:10px">${started}</td>
      <td style="font-size:10px">${finished}</td>
      <td style="font-size:10px;font-weight:600">${duration}</td>
    </tr>`;
  }).join('');
}

let _jsonData=null;

// ===== BACKUP & RECOVERY =====
const backupFiles = [
  {name:'SOUL.md', desc:'Forge\'s identity & personality', url:'https://raw.githubusercontent.com/AntonUrso2811/forge-workspace/main/SOUL.md'},
  {name:'USER.md', desc:'About Anton â€” context & preferences', url:'https://raw.githubusercontent.com/AntonUrso2811/forge-workspace/main/USER.md'},
  {name:'MEMORY.md', desc:'Long-term memory â€” everything Forge knows', url:'https://raw.githubusercontent.com/AntonUrso2811/forge-workspace/main/MEMORY.md'},
  {name:'AGENTS.md', desc:'Operating instructions & rules', url:'https://raw.githubusercontent.com/AntonUrso2811/forge-workspace/main/AGENTS.md'},
  {name:'IDENTITY.md', desc:'Name, emoji, birth date', url:'https://raw.githubusercontent.com/AntonUrso2811/forge-workspace/main/IDENTITY.md'},
  {name:'TOOLS.md', desc:'Local tool notes & config', url:'https://raw.githubusercontent.com/AntonUrso2811/forge-workspace/main/TOOLS.md'},
  {name:'SOS.md', desc:'Emergency recovery guide', url:'https://raw.githubusercontent.com/AntonUrso2811/forge-workspace/main/SOS.md'},
];

function renderBackupFiles(){
  const el=document.getElementById('backup-files');
  if(!el)return;
  el.innerHTML=backupFiles.map(f=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
      <div>
        <div style="font-size:12px;font-weight:600">${f.name}</div>
        <div style="font-size:10px;color:var(--muted)">${f.desc}</div>
      </div>
      <button class="btn-s btn-o" onclick="downloadFile('${f.url}','${f.name}')">ğŸ“¥</button>
    </div>
  `).join('');
}

async function downloadFile(url,name){
  try{
    const r=await fetch(url);
    if(!r.ok)throw new Error('Failed');
    const b=await r.blob();
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    a.download=name;
    a.click();
    toast('Downloaded '+name);
  }catch(e){
    toast('Failed â€” open GitHub directly');
    window.open('https://github.com/AntonUrso2811/forge-workspace','_blank');
  }
}

async function downloadAllBackup(){
  toast('Downloading files individually...');
  for(const f of backupFiles){
    await downloadFile(f.url,f.name);
    await new Promise(r=>setTimeout(r,500));
  }
  toast('All files downloaded âœ…');
}

renderBackupFiles();

// ===== INIT =====
document.getElementById('d-date').valueAsDate=new Date();
document.getElementById('e-date').valueAsDate=new Date();
document.getElementById('s-company').value=D.company.name;
document.getElementById('s-cur').value=D.company.currency;
document.getElementById('s-tax').value=D.company.taxRate;
document.getElementById('s-margin').value=D.company.targetNetMargin;
document.getElementById('d-brand').onchange=updateProdDropdown;
render();
loadFromJSON();
</script>
</body>
</html>
